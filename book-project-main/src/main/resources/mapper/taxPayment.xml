<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bk.project.taxPayment.mapper.TaxPaymentMapper">

    <!-- 세금 납부 등록 -->
    <insert id="insertTaxPayment" parameterType="com.bk.project.taxPayment.vo.TaxPayment" useGeneratedKeys="true" keyProperty="taxPaymentNo">
        INSERT INTO tax_payment (tax_no, amount, payment_date, payment_method, status, description)
        VALUES (#{taxNo}, #{amount}, #{paymentDate}, #{paymentMethod}, #{status}, #{description})
    </insert>
    
	<!--세금 일부 납부 시 계산 로직
	<![CDATA[ < ]]> 뭐가 깨졋다해서 씀-->
	<update id="updateTaxStatus" parameterType="int">
      UPDATE tax
    SET status = CASE
        WHEN (SELECT COALESCE(SUM(amount), 0) FROM tax_payment WHERE tax_no = #{taxNo}) = 0 
            THEN 'PENDING'
        WHEN (SELECT COALESCE(SUM(amount), 0) FROM tax_payment WHERE tax_no = #{taxNo}) <![CDATA[ < ]]> tax_amount
            THEN 'PARTIAL'
        ELSE 'PAID'
    END
    WHERE tax_no = #{taxNo}
	</update>
    <!-- 납부 대상 세금 목록 (미납/할부만) -->
   <select id="selectUnpaidTaxes" resultType="com.bk.project.tax.vo.Tax">
    SELECT 
    t.tax_no,
    t.category,
    t.tax_amount,
    t.tax_date,
    (t.tax_amount - COALESCE(SUM(tp.amount), 0)) AS remaining_amount
	FROM tax t
	LEFT JOIN tax_payment tp 
    ON t.tax_no = tp.tax_no
	GROUP BY t.tax_no, t.category, t.tax_amount, t.tax_date
	HAVING remaining_amount > 0
	</select>
	
	<select id="selectOneUnpaidTaxes" parameterType="int" resultType="com.bk.project.tax.vo.Tax">
    SELECT 
    (t.tax_amount - COALESCE(SUM(tp.amount), 0)) AS remaining_amount,
    t.tax_amount
	FROM tax t
	LEFT JOIN tax_payment tp 
    ON t.tax_no =
    tp.tax_no
    WHERE t.tax_no = #{taxNo}
	HAVING remaining_amount > 0;
	</select>
	
	

	<!-- 납부 완료 세금 조회 -->
	<select id="selectPaidTaxes" resultType="com.bk.project.taxPayment.vo.TaxPayment">
    SELECT t.tax_no, t.category, t.tax_amount, t.tax_date,t.status,
           tp.amount, tp.payment_date, tp.payment_method, tp.description
    FROM tax t
    INNER JOIN tax_payment tp 
        ON t.tax_no = tp.tax_no
    ORDER BY tp.payment_date DESC
	</select>
	
	
<!--세금 월별 검색(페이징 계산용)-->
<!-- 전체 납부 내역 조회 -->
<select id="allTaxPaidList" parameterType="TaxPagingDTO" resultType="com.bk.project.taxPayment.vo.TaxPayment">
  SELECT tp.tax_payment_no AS taxPaymentNo,
         tp.tax_no AS taxNo,
         tp.amount,
         tp.payment_date AS paymentDate,
         tp.payment_method AS paymentMethod,
         tp.status,
         tp.description,
         t.category,
         t.tax_amount AS taxAmount,
         t.tax_date AS taxDate
  FROM tax_payment tp
  JOIN tax t ON tp.tax_no = t.tax_no
  ORDER BY tp.payment_date DESC
  LIMIT #{limit} OFFSET #{offset}
</select>

<!-- 전체 카운트 -->
<select id="countAllTaxPaidList" resultType="int">
  SELECT COUNT(*) 
  FROM tax_payment tp
    JOIN tax t ON tp.tax_no = t.tax_no
</select>

<!-- 조건 검색 -->
<select id="searchTaxPaidList" parameterType="com.bk.project.taxPayment.dto.TaxPagingDTO"
        resultType="com.bk.project.taxPayment.vo.TaxPayment">
  SELECT tp.tax_payment_no AS taxPaymentNo,
         tp.tax_no AS taxNo,
         tp.amount,
         tp.payment_date AS paymentDate,
         tp.payment_method AS paymentMethod,
         tp.status,
         tp.description,
         t.category,
         t.tax_amount AS taxAmount,
         t.tax_date AS taxDate
  FROM tax_payment tp
  JOIN tax t ON tp.tax_no = t.tax_no
  WHERE DATE_FORMAT(tp.payment_date, '%Y-%m') = #{month}
  ORDER BY tp.payment_date DESC
 LIMIT #{limit} OFFSET #{offset}
</select>

<!-- 검색 카운트 -->
<select id="countSearchTaxPaidList" parameterType="String" resultType="int">
  SELECT COUNT(*)
  FROM tax_payment tp
  JOIN tax t ON tp.tax_no = t.tax_no
  WHERE DATE_FORMAT(tp.payment_date, '%Y-%m') = #{month}
</select>
	
<select id="taxAmonutSelectByNo" parameterType="int" resultType="com.bk.project.tax.vo.Tax">
select * from tax
where tax_no =#{taxNo};
</select>

<select id="selectSumPaymentByNo" parameterType="int" resultType="int">
select sum(amount)
from tax_payment
where tax_no = #{taxNo};
</select>
<update id="updatePaidTax" parameterType="TaxPayment">
  UPDATE tax_payment tp
  JOIN (
    SELECT MAX(tax_payment_no) AS max_tax_payment_no
    FROM tax_payment
    WHERE amount = #{amount}
      AND tax_no = #{taxNo}
  ) latest
  ON tp.tax_payment_no = latest.max_tax_payment_no
SET tp.status = 'PAID'
</update>
</mapper>