<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bk.project.partner.mapper.PartnerMapper">

<resultMap id="partnerMap" type="Partner">
<id property="partnerNo"  column="partner_no"/>
<result property="name" column="name"/>
<result property="type" column="type"/>
<result property="startDate" column="start_date"/>
<result property="endDate" column="end_date"/>
</resultMap>

<!-- 거래처 등록 -->
<insert id="newPartner" parameterType="Partner">
    INSERT INTO partner (name, type, start_date, end_date)
    SELECT #{name}, #{type}, #{startDate}, #{endDate}
    FROM DUAL 
    WHERE NOT EXISTS (
        SELECT 1 FROM partner
        WHERE name = #{name}
          AND type = #{type}
          AND start_date = #{startDate}
          AND end_date = #{endDate}
	)
</insert>

<!-- 거래처 전체 조회 -->
<select id="allPartner"  resultMap="partnerMap">
SELECT * FROM partner
</select>

<!-- 거래처 조회 -->
<select id="searchPartner" parameterType="PartnerPagingDTO" resultMap="partnerMap">
SELECT * FROM partner
<where>
	<choose>
		<when test="select == 'name' and keyword != null and keyword!=''">
			name LIKE  CONCAT('%', #{keyword}, '%')
		</when>
		<when test="select == 'type' and keyword != null and keyword!=''">
			type LIKE  CONCAT('%', #{keyword}, '%')
		</when>
	</choose>
</where>
LIMIT #{limit} OFFSET #{offset}
</select>

<!--페이징 처리-->
<select id="countPartner" parameterType="PartnerPagingDTO" resultType="int">
SELECT COUNT(*) FROM partner
<where>
	<choose>
		<when test="select == 'name' and keyword != null and keyword != ''">
			name LIKE CONCAT('%',#{keyword},'%')
		</when>
		<when test="select == 'type' and keyword != null and keyword != ''">
			type LIKE CONCAT('%',#{keyword},'%')
		</when>
	</choose>
</where>

</select>

<!-- allPartner에서 선택한 책 목록 불러오기 -->
<select id="selectUpdate" parameterType="int" resultMap="partnerMap">
SELECT * FROM partner
WHERE partner_no = #{partnerNo}
</select>

<!-- 거래처 정보 변경 -->
<update id="updatePartner" parameterType="Partner">
    UPDATE partner
    <set>
        <if test="name != null and name != ''">
            name = #{name},
        </if>
        <if test="startDate != null">
            start_date = #{startDate},
        </if>
        <if test="endDate != null">
            end_date = #{endDate},
        </if>
    </set>
    WHERE partner_no = #{partnerNo}
</update>

<!--거래처 정보 삭제-->
<delete id="deletePartner" parameterType="int">
DELETE FROM partner
WHERE partner_no = #{partnerNo};
</delete>

<!-- 클레임에서 거래처 목록 불러오기 -->
<select id="findPartnerNo" parameterType="int" resultMap="partnerMap">
  SELECT * FROM partner
  WHERE partner_no = #{partnerNo}
</select>

<!-- 거래처 정보 수정 시 값 불러오기 -->
<select id="getPartner" parameterType="int" resultMap="partnerMap">
SELECT partner_no, name, type, start_date, end_date
  FROM partner
  WHERE partner_no = #{partnerNo}
</select>
</mapper>