<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bk.project.printorder.mapper.PrintOrderMapper">

<resultMap id="PrintOrderMap" type="com.bk.project.printorder.vo.PrintOrder">
    <!-- 부모 -->
    <id property="orderNo" column="order_no"/>
    <result property="orderDate" column="order_date"/>
    <result property="category" column="category"/>
    <result property="manager" column="manager"/>
    <result property="deliveryDate" column="delivery_date"/>
    <result property="issueDate" column="issue_date"/>
    <result property="status" column="status"/>
      <result property="qualityChecked" column="quality_checked" jdbcType="TINYINT" />

    <!-- 자식 detailList -->
  <collection property="detailList" ofType="com.bk.project.printorder.vo.PrintOrderDetailVO">
    <id property="detailNo" column="detail_no"/>
    <result property="bookNo" column="book_no"/>
    <result property="productName" column="product_name"/>
    <result property="regularPrice" column="regular_price"/>
    <result property="quantity" column="quantity"/>
    <result property="totalAmount" column="total_amount"/>
    <result property="promotionQuantity" column="promotion_quantity"/>
    <result property="printDate" column="print_date"/>
</collection>
</resultMap>

<resultMap id="selectPrintOlderMap" type="printOrderDTO">
    <id property="orderNo" column="order_no" />
    <result property="bookNo" column="book_no" />
    <result property="productName" column="product_name" />
    <result property="quantity" column="quantity" />
    <result property="promotionQuantity" column="promotion_quantity" />
    <result property="manager" column="manager" />
    <result property="issueDate" column="issue_date" />
    <result property="deliveryDate" column="delivery_date" />
     <result property="printDate" column="print_date"/>
</resultMap>

<select id="getPrintOrderByNo" resultMap="PrintOrderMap" parameterType="int">
   SELECT 
    po.order_no        AS order_no,
    po.order_date      AS order_date,
    po.category        AS category,
    po.manager         AS manager,
    po.delivery_date   AS delivery_date,
    po.issue_date      AS issue_date,
    po.status          AS status,
    po.quality_checked AS quality_checked,
    pod.detail_no          AS detail_no,
    pod.book_no            AS book_no,
    pod.product_name       AS product_name,
    pod.regular_price      AS regular_price,
    pod.quantity           AS quantity,
    pod.total_amount       AS total_amount,
    pod.promotion_quantity AS promotion_quantity

  FROM print_order po
  JOIN print_order_detail pod ON po.order_no = pod.order_no
  WHERE po.order_no = #{orderNo}
</select>
<!-- 발주 상세 조회 -->
<select id="getPrintOrderDetailByNo" parameterType="int"
        resultType="com.bk.project.printorder.vo.PrintOrderDetailVO">
    SELECT 
        pod.detail_no,
        pod.order_no,
        pod.book_no,
        pod.product_name,
        pod.regular_price,
        pod.quantity,
        pod.total_amount,
        pod.promotion_quantity
    FROM print_order_detail pod
    WHERE pod.order_no = #{orderNo}
</select>

<insert id="newPrintOrder" parameterType="PrintOrder" useGeneratedKeys="true" 
keyProperty="orderNo">
  INSERT INTO print_order (
    order_date, category, manager, delivery_date, issue_date
  ) VALUES (
    #{orderDate}, #{category}, #{manager}, #{deliveryDate}, #{issueDate}
  )
</insert>

<insert id="newPrintOrderDetail" parameterType="PrintOrderDetailVO">
	INSERT INTO print_order_detail (
		order_no, book_no, product_name, regular_price, quantity, total_amount, promotion_quantity)
	VALUES (#{orderNo}, #{bookNo}, #{productName}, #{regularPrice}, #{quantity}, #{totalAmount}, #{promotionQuantity})
</insert>
<select id="allPrintOrder" parameterType="PrintOrderPagingDTO"
        resultType="com.bk.project.printorder.vo.PrintOrder">
  SELECT 
    po.order_no,
    po.order_date,
    po.category,
    po.manager,
    po.delivery_date,
    po.issue_date,
    po.status,
    po.quality_checked
  FROM print_order po
  ORDER BY po.order_no DESC
  LIMIT #{limit} OFFSET #{offset}
</select>

<select id="countAllPrintOrder" resultType="int">
  SELECT COUNT(*) FROM print_order
</select>





<select id="searchPrintOrder" parameterType="PrintOrderPagingDTO" resultMap="PrintOrderMap">
      SELECT po.*,
           MIN(pod.detail_no) AS detail_no  -- 대표값만 가져옴
    FROM print_order po
    JOIN print_order_detail pod ON po.order_no = pod.order_no
    JOIN book b ON pod.book_no = b.book_no
    <where>
        <if test="keyword != null and keyword != ''">
            (b.title LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(po.order_no AS CHAR) LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </where>
    GROUP BY po.order_no
    ORDER BY CASE WHEN po.status = '배송 완료' THEN 1 ELSE 0 END,
             po.order_no DESC
    LIMIT #{limit} OFFSET #{offset}
</select>

<select id="countPrintOrder" parameterType="PrintOrderPagingDTO" resultType="int">
 SELECT COUNT(DISTINCT po.order_no)
    FROM print_order po
    JOIN print_order_detail pod ON po.order_no = pod.order_no
    JOIN book b ON pod.book_no = b.book_no
    <where>
        <if test="keyword != null and keyword != ''">
            (b.title LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(po.order_no AS CHAR) LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </where>
</select>

<!--발주서 업데이트-->
<update id="updatePrintOrder" parameterType="PrintOrder">
UPDATE print_order
SET 
manager = #{manager},
issue_date = #{issueDate},
delivery_date = #{deliveryDate},
order_date = #{orderDate}
WHERE order_no = #{orderNo}
</update>

<select id="selectDetail" parameterType="PrintOrderDetailVO">
SELEct * 
FROM  print_order_detail
WHERE order_no = #{orderNo} 
AND book_no = #{bookNo}
AND detail_no = #{detailNo}
</select>

<delete id="deletePrintOrderDetail" parameterType="PrintOrderDetailVO">
DELETE FROM print_order_detail
WHERE order_no = #{orderNo} 
AND book_no = #{bookNo}
</delete>

<!--detail 새로 엄데이트-->
<update id="updateInvenQuantity" parameterType="PrintOrderDetailVO">
UPDATE print_order_detail
SET quantity = #{quantity}
WHERE order_no = #{orderNo} 
AND book_no = #{bookNo}
</update>

<!--배송 상태 변경-->
<update id="updateStatus" parameterType="printOrderPagingDTO">
	UPDATE print_order SET status = #{status}
	WHERE order_no= #{orderNo}
</update>

<!-- 배송완료 도서 목록 조회 -->
<select id="deliveryStatusByOrderNo" parameterType="int" 
        resultType="com.bk.project.printorder.vo.PrintOrderDetailVO">
    SELECT 
        detail_no,
        order_no,
        book_no,
        product_name,
        regular_price,
        quantity,
        promotion_quantity,
        total_amount
    FROM print_order_detail
    WHERE order_no = #{orderNo}
</select>

<select id="selectStatus" parameterType="int" resultType="string">
    SELECT status 
    FROM print_order
    WHERE order_no = #{orderNo}
</select>
<!--발주서 삭제-->
<delete id="deletePrintOrder" parameterType="int">
    DELETE FROM print_order WHERE order_no = #{orderNo}
</delete>

<delete id="deletePrintOrderDetailByOrderNo" parameterType="int">
    DELETE FROM print_order_detail WHERE order_no = #{orderNo}
</delete>


<!-- 계약 삭제 시 발주서 삭제-->
<delete id="deleteByBookNo">
    DELETE FROM print_order_detail WHERE book_no = #{bookNo}
</delete>

  <!-- 품질 검수 대상 목록 조회 (전체) -->
  <select id="allQualityCheckTarget" parameterType="PrintOrderPagingDTO"
          resultMap="PrintOrderMap">
  SELECT 
    po.order_no,
    po.order_date,
    po.category,
    po.manager,
    po.delivery_date,
    po.issue_date,
    po.status,
    po.quality_checked,
    pod.detail_no,
    pod.book_no,
    pod.product_name,
    pod.regular_price,
    pod.quantity,
    pod.promotion_quantity,
    pod.total_amount
  FROM (
    SELECT DISTINCT po2.order_no
    FROM print_order po2
    WHERE po2.status = '배송 완료'
    ORDER BY po2.order_no DESC
    LIMIT #{limit} OFFSET #{offset}
  ) sub
  JOIN print_order po ON po.order_no = sub.order_no
  JOIN print_order_detail pod ON po.order_no = pod.order_no
  ORDER BY po.order_no DESC
  </select>

<!-- 품질 검수 대상 목록 조회 (검색) - printorder -->
<select id="qualityCheckTarget" parameterType="PrintOrderPagingDTO"
        resultMap="PrintOrderMap">
    SELECT 
    po.order_no       AS order_no,
    po.order_date     AS order_date,
    po.category       AS category,
    po.manager        AS manager,
    po.delivery_date  AS delivery_date,
    po.issue_date     AS issue_date,
    po.status         AS status,
    po.quality_checked AS quality_checked,
    pod.detail_no          AS detail_no,
    pod.book_no            AS book_no,
    pod.product_name       AS product_name,
    pod.regular_price      AS regular_price,
    pod.quantity           AS quantity,
    pod.promotion_quantity AS promotion_quantity,
    pod.total_amount       AS total_amount
  FROM print_order po
  JOIN print_order_detail pod ON po.order_no = pod.order_no
  JOIN (
      SELECT po2.order_no
      FROM print_order po2
      WHERE po2.status = '배송 완료'
        AND (
          po2.manager LIKE CONCAT('%', #{keyword}, '%')
          OR CAST(po2.order_no AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
        )
      ORDER BY po2.order_no DESC
      LIMIT #{limit} OFFSET #{offset}
  ) sub ON po.order_no = sub.order_no
  ORDER BY po.order_no DESC
</select>
<!-- 품질 검수 대상 목록 조회 (검색) - printOrderDetail -->
  <select id="getPrintOrderDetailByOrderNo" parameterType="int"
        resultType="PrintOrderDetailVO">
    SELECT 
        pod.detail_no,
        pod.order_no,
        pod.book_no,
        pod.product_name,
        pod.regular_price,
        pod.quantity,
        pod.total_amount,
        pod.promotion_quantity,
        c.print_date   AS print_date   
    FROM print_order_detail pod
    JOIN book b ON pod.book_no = b.book_no
    LEFT JOIN contract c ON b.contract_no = c.contract_no
    WHERE pod.order_no = #{orderNo}
</select>
 <!-- 페이징 처리용 (검색) -->
  <select id="countQualityCheckTarget" parameterType="PrintOrderPagingDTO" resultType="int">
     SELECT COUNT(DISTINCT po.order_no)
  FROM print_order po
  JOIN print_order_detail pod ON po.order_no = pod.order_no
  WHERE po.status = '배송 완료'
  <if test="keyword != null and keyword != ''">
    AND (
      po.manager LIKE CONCAT('%', #{keyword}, '%')
      OR CAST(po.order_no AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
    )
  </if>
  </select>

  <!-- 전체 개수 -->
  <select id="countAllQualityCheckTarget" resultType="int">
      SELECT COUNT(DISTINCT po.order_no)
  FROM print_order po
  JOIN print_order_detail pod ON po.order_no = pod.order_no
  WHERE po.status = '배송 완료'
  </select>
  <!--검수 체크-->
<update id="updateQualityChecked" parameterType="int">
    UPDATE print_order
    SET quality_checked = 1
    WHERE order_no = #{orderNo}
</update>



</mapper>